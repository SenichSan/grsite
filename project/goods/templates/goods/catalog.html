{% load static %}
{% load media_extras %}

<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Каталог</title>
    <!-- Performance hints -->
    <link rel="preconnect" href="https://code.jquery.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Global styles matching home (container visuals) -->
    <link rel="preload" as="style" href="{% static 'deps/css/templatemo-style.css' %}">
    <link href="{% static 'deps/css/templatemo-style.css' %}" rel="stylesheet"/>
    <!-- Page-specific (currently empty/minimal) -->
    <link rel="preload" as="style" href="{% static 'deps/css/header-hero.css' %}">
    <link rel="stylesheet" href="{% static 'deps/css/header-hero.css' %}">
    <!-- Secondary styles via preload+onload to avoid render-blocking -->
    <link rel="preload" as="style" href="{% static 'deps/css/catalog.css' %}" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="{% static 'deps/css/catalog.css' %}"></noscript>
    <link rel="preload" as="style" href="{% static 'deps/css/bestsellers-carousel.css' %}" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="{% static 'deps/css/bestsellers-carousel.css' %}"></noscript>
    <link rel="preload" as="style" href="{% static 'deps/css/cart-component.css' %}" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="{% static 'deps/css/cart-component.css' %}"></noscript>
    <link rel="preload" as="style" href="{% static 'deps/css/footer.css' %}" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="{% static 'deps/css/footer.css' %}"></noscript>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
            href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@300;400;500;600;700&family=Roboto:wght@400;500;700&display=swap"
            rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Marck+Script&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Ruslan+Display&display=swap" rel="stylesheet">
    <link href="{% static 'deps/css/discount_badge.css' %}" rel="stylesheet"/>
</head>

<body>
<div class="container home-framed">
    {% include 'components/header-hero.html' %}
    
    <!-- Catalog categories block (new, catalog-scoped) -->
    <div class="catalog-categories">
        <nav class="catalog-categories-nav" aria-label="Категории">
            <h1 class="catalog-title">Каталог</h1>
            <h2 class="catalog-categories-subtitle"> Натисніть на категорію для фільтрації товарів</h2>
            <ul class="catalog-categories-list">
                {% for category in categories %}
                <li class="catalog-category-item">
                    <a href="{% url 'catalog:index' category.slug %}"
                       class="catalog-category-card"
                       data-category="{{ category.slug }}"
                       aria-current="{% if category.slug == current_category %}true{% endif %}">
                        <div class="catalog-category-icon-wrap">
                            {% category_icon_picture category '128x128' 'catalog-category-icon' category.name 128 128 %}
                        </div>
                        <div class="catalog-category-label">{{ category.name }}</div>
                        {# Removed short description from catalog category card #}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </nav>
    </div>


    <!-- Products container: initial SSR render; later replaced via AJAX -->
    <div class="tm-featured-wrapper tm-fw-mobile">
      <section id="catalog-products" class="catalog-products container-bestsellers basic-grid" aria-live="polite">
          {% include 'goods/_products_list.html' %}
      </section>
    </div>

    {# Standalone container for category presentation; will be filled from partial via JS #}
    <div id="category-presentation-container"></div>

    {% include 'components/footer.html' %}
</div>

{% include 'components/cart_button.html' %}
{% include 'components/cart_modal.html' %}

<!-- jQuery core (needed for jquery-ajax.js handlers) -->
<script defer src="{% static 'deps/js/jquery/jquery-3.7.0.min.js' %}"></script>

<!-- Toast notifications stack and helper -->
<script>
  (function(){
    // create stack once per page
    let stack = document.querySelector('.tm-toast-stack');
    if (!stack) {
      stack = document.createElement('div');
      stack.className = 'tm-toast-stack';
      stack.setAttribute('aria-live', 'polite');
      stack.setAttribute('aria-atomic', 'true');
      document.body.appendChild(stack);
    }

    function showToast(options){
      const o = typeof options === 'string' ? { message: options } : (options || {});
      const title = o.title || '';
      const message = o.message || '';
      const actionText = o.actionText || '';
      const onAction = typeof o.onAction === 'function' ? o.onAction : null;
      const duration = Math.max(1200, Math.min(6000, o.duration || 2000));
      const variant = o.variant || 'bare'; // 'bare' | 'default'
      const closable = o.closable !== false && variant !== 'bare';

      let toast = document.createElement('div');
      toast.className = 'tm-toast';
      toast.setAttribute('role', 'status');

      const content = document.createElement('div');
      content.className = 'tm-toast-content';
      if (title) {
        const h = document.createElement('div');
        h.className = 'tm-toast-title';
        h.textContent = title;
        content.appendChild(h);
      }
      const p = document.createElement('div');
      p.className = 'tm-toast-message';
      p.textContent = message;
      content.appendChild(p);

      let closeBtn = null;
      if (closable) {
        closeBtn = document.createElement('button');
        closeBtn.className = 'tm-toast-close';
        closeBtn.type = 'button';
        closeBtn.setAttribute('aria-label', 'Закрыть');
        closeBtn.innerHTML = '&times;';
      }

      let actionBtn = null;
      if (actionText && variant !== 'bare') {
        actionBtn = document.createElement('button');
        actionBtn.type = 'button';
        actionBtn.className = 'tm-toast-action';
        actionBtn.textContent = actionText;
      }

      toast.appendChild(content);
      if (actionBtn) toast.appendChild(actionBtn);
      if (closeBtn) toast.appendChild(closeBtn);
      if (variant === 'bare') toast.classList.add('tm-toast--bare');
      stack.appendChild(toast);

      requestAnimationFrame(() => toast.classList.add('visible'));

      let timer = setTimeout(dismiss, duration);
      function dismiss(){
        if (!toast) return;
        toast.classList.remove('visible');
        setTimeout(() => { if (toast) toast.remove(); toast = null; }, 220);
      }
      if (closeBtn) closeBtn.addEventListener('click', dismiss);
      toast.addEventListener('mouseenter', () => { clearTimeout(timer); });
      toast.addEventListener('mouseleave', () => { timer = setTimeout(dismiss, 900); });
      if (actionBtn && onAction) {
        actionBtn.addEventListener('click', () => { try { onAction(); } catch(_){} dismiss(); });
      }

      return { dismiss };
    }

    window.showToast = showToast;
  })();
</script>

<!-- Global AJAX handlers for cart actions (legacy + .add-to-cart-btn) -->
<script defer src="{% static 'deps/js/jquery-ajax.js' %}"></script>

<!-- New cart component (modal + counter sync) -->
<script defer src="{% static 'deps/js/cart-component.js' %}"></script>

<script>
(function() {
  const productsEl = document.getElementById('catalog-products');
  const categoriesWrap = document.querySelector('.catalog-categories');

  function setActiveCategory(slug) {
    document.querySelectorAll('.catalog-category-card').forEach(a => {
      const isActive = a.getAttribute('data-category') === slug;
      if (isActive) {
        a.setAttribute('aria-current', 'true');
        a.classList.add('is-active');
      } else {
        a.removeAttribute('aria-current');
        a.classList.remove('is-active');
      }
    });
  }

  // Dynamic 3D tilt similar to bestsellers; safe to call repeatedly
  function initTilt(){
    if (!productsEl) return;
    // Disable tilt on touch/coarse pointers and small screens (match home logic)
    try {
      const isCoarse = window.matchMedia('(pointer: coarse)').matches;
      const noHover = window.matchMedia('(hover: none)').matches;
      const isSmall = window.matchMedia('(max-width: 768px)').matches;
      if (isCoarse || noHover || isSmall) {
        document.documentElement.classList.add('tilt-disabled');
        return; // do not bind tilt on mobile/coarse devices
      }
    } catch(_) {}
    const cards = productsEl.querySelectorAll('.tm-featured-grid article.tm-product-card');
    if (!cards.length) return;
    const maxTilt = 8;     // degrees
    const maxTrans = 10;   // px for image parallax

    function onMove(e, card){
      const rect = card.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      const px = (clientX - rect.left) / rect.width;   // 0..1
      const py = (clientY - rect.top) / rect.height;   // 0..1
      const rotateY = (px - 0.5) * (maxTilt * 2) * -1; // left/right
      const rotateX = (py - 0.5) * (maxTilt * 2);      // up/down
      card.setAttribute('data-tilt-active', '1');
      card.style.transform = `perspective(900px) rotateX(${rotateX.toFixed(2)}deg) rotateY(${rotateY.toFixed(2)}deg) scale(1.03)`;
      card.style.willChange = 'transform';
      const img = card.querySelector('.tm-card-img');
      if (img) {
        const tx = (px - 0.5) * maxTrans;
        const ty = (py - 0.5) * maxTrans * -1;
        img.style.transform = `translate(${tx.toFixed(1)}px, ${ty.toFixed(1)}px) scale(1.04)`;
        img.style.willChange = 'transform';
      }
    }

    function onLeave(card){
      // remove active flag immediately so glow disappears at once
      card.removeAttribute('data-tilt-active');
      // smoothly return transform
      card.style.transition = 'transform 420ms cubic-bezier(.2,.9,.25,1)';
      card.style.transform = '';
      const img = card.querySelector('.tm-card-img');
      if (img) {
        img.style.transition = 'transform 420ms cubic-bezier(.2,.9,.25,1)';
        img.style.transform = '';
      }
      setTimeout(() => {
        card.style.transition = '';
        card.style.willChange = '';
        if (img) { img.style.transition = ''; img.style.willChange = ''; }
      }, 450);
    }

    cards.forEach(card => {
      if (card.dataset.tiltBound) return; // avoid double-binding
      card.dataset.tiltBound = '1';
      card.addEventListener('mousemove', (e) => onMove(e, card));
      card.addEventListener('mouseleave', () => onLeave(card));
      card.addEventListener('touchstart', (e) => onMove(e, card), {passive: true});
      card.addEventListener('touchmove', (e) => onMove(e, card), {passive: true});
      card.addEventListener('touchend', () => onLeave(card));
    });
  }

  function buildURL(href, page) {
    try {
      const url = new URL(href, window.location.origin);
      if (page) url.searchParams.set('page', String(page));
      return url.toString();
    } catch (e) {
      return href; // fallback
    }
  }

  async function loadProducts(url, {pushState=true} = {}) {
    if (!productsEl) return;
    const controller = new AbortController();
    const loadingHTML = '<div class="loading" role="status">Загрузка…</div>';
    productsEl.innerHTML = loadingHTML;
    try {
      const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }, signal: controller.signal });
      if (!res.ok) throw new Error('Network error');
      const html = await res.text();
      // Create a detached DOM to query both products and category presentation
      const tmp = document.createElement('div');
      tmp.innerHTML = html;
      const newPresentation = tmp.querySelector('#category-presentation');
      const newProducts = tmp.innerHTML; // full partial content
      productsEl.innerHTML = newProducts;
      // Move category presentation out into a standalone container (replace existing)
      try {
        const host = document.getElementById('category-presentation-container');
        const inProducts = productsEl.querySelector('#category-presentation');
        if (host) {
          host.innerHTML = '';
          if (inProducts) {
            host.appendChild(inProducts);
          } else if (newPresentation) {
            host.appendChild(newPresentation);
          }
        } else if (inProducts) {
          // Fallback: if host not found, keep it inside products
        }
      } catch(_) {}

      // scroll into view for better UX
      productsEl.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // Bind pagination clicks inside the newly injected content
      bindPagination();

      // Re-init tilt handlers for newly injected cards
      initTilt();

      // Bind species filter buttons inside the newly injected content
      bindSpeciesFilter();


      if (pushState) {
        history.pushState({ url }, '', url);
      }
    } catch (err) {
      productsEl.innerHTML = '<div class="error">Не удалось загрузить товары. <button type="button" class="retry">Повторить</button></div>';
      const btn = productsEl.querySelector('.retry');
      if (btn) btn.addEventListener('click', () => loadProducts(url, {pushState:false}));
    }
  }

  function onCategoryClick(e) {
    const a = e.target.closest('a.catalog-category-card');
    if (!a) return;
    // Allow Ctrl/Meta click to open in new tab
    if (e.ctrlKey || e.metaKey || e.shiftKey || e.altKey) return;
    e.preventDefault();
    const slug = a.getAttribute('data-category');
    setActiveCategory(slug);
    const url = buildURL(a.href, 1);
    loadProducts(url, {pushState:true});
  }

  function bindPagination() {
    productsEl.querySelectorAll('a.pagination-link').forEach(link => {
      link.addEventListener('click', function(e) {
        if (e.ctrlKey || e.metaKey || e.shiftKey || e.altKey) return;
        e.preventDefault();
        const url = buildURL(this.href);
        loadProducts(url, {pushState:true});
      });
    });
  }

  function bindSpeciesFilter(){
    if (!productsEl) return;
    productsEl.querySelectorAll('.species-filter-nav a.catalog-category-card').forEach(link => {
      if (link.dataset.sfBound) return;
      link.dataset.sfBound = '1';
      link.addEventListener('click', function(e){
        if (e.ctrlKey || e.metaKey || e.shiftKey || e.altKey) return;
        e.preventDefault();
        const url = this.href;
        loadProducts(url, {pushState:true});
      });
    });
  }

  // Initial bindings
  if (categoriesWrap) {
    categoriesWrap.addEventListener('click', onCategoryClick);
  }
  bindPagination();
  initTilt();
  bindSpeciesFilter();
  // On first render (SSR), if the partial included category presentation, move it out
  (function initialMovePresentation(){
    try {
      const host = document.getElementById('category-presentation-container');
      if (!host) return;
      const inProducts = productsEl && productsEl.querySelector('#category-presentation');
      if (inProducts) {
        host.innerHTML = '';
        host.appendChild(inProducts);
      }
    } catch(_) {}
  })();

  // Handle back/forward
  window.addEventListener('popstate', (e) => {
    const url = (e.state && e.state.url) ? e.state.url : window.location.href;
    loadProducts(url, {pushState:false});
    // Try to sync active category based on URL path
    try {
      const u = new URL(url, window.location.origin);
      const pathParts = u.pathname.split('/').filter(Boolean);
      const slug = pathParts[pathParts.length - 1]; // expects .../catalog/<slug>/
      if (slug) setActiveCategory(slug);
    } catch (_) {}
  });
})();
</script>

<!-- Tawk.to (minimized on load) -->
<script type="text/javascript">
  window.Tawk_API = window.Tawk_API || {};
  window.Tawk_LoadStart = new Date();
  Tawk_API.onLoad = function(){
    try { Tawk_API.showWidget(); Tawk_API.minimize(); } catch(e) {}
  };
  (function(){
    var s1=document.createElement('script'), s0=document.getElementsByTagName('script')[0];
    s1.async=true; s1.src='https://embed.tawk.to/6896970ca4fc79192a7bea9e/1j263s266';
    s1.charset='UTF-8'; s1.setAttribute('crossorigin','*');
    s0.parentNode.insertBefore(s1,s0);
  })();
</script>
</body>

</html>
