{% load static %}
{% load media_extras %}

<div class="catalog-current-title">
    {% if current_category and current_category != 'all' %}
        {% for cat in categories %}
            {% if cat.slug == current_category %}
                <h2 class="catalog-category-heading">Товари категорії <span>{{ cat.name }}</span></h2>
            {% endif %}
        {% endfor %}
    {% else %}
        <h2 class="catalog-category-heading">Всі товари</h2>
    {% endif %}
    
</div>

<div class="tm-featured-grid" role="list" aria-label="Товары">
    {% for product in goods %}
    <article class="tm-product-card" role="listitem" aria-labelledby="prod-title-{{ product.id }}">
        <a href="{% url 'goods:product' product.slug %}" class="tm-product-link" aria-label="{{ product.name }}">
            <div class="tm-card-image-wrap">
                <div class="badge-stack">
                    {% if product.discount and product.discount|floatformat:2 != '0.00' %}
                    <div class="badge-discount badge-discount--sm" aria-label="Скидка: {{ product.discount_price|floatformat:0 }}₴">
                        Скидка: <span class="bd-amt">{{ product.discount_price|floatformat:0 }}₴</span>
                    </div>
                    {% endif %}
                    {% if product.quantity <= 0 %}
                    <div class="badge-stock is-out" aria-label="Немає в наявності">немає в наявності</div>
                    {% elif product.quantity <= 15 and product.quantity > 10 %}
                    <div class="badge-stock is-low" aria-label="Залишилось: {{ product.quantity }}">
                        залишилось: <span class="st-amt">{{ product.quantity }}</span>
                    </div>
                    {% elif product.quantity <= 10 and product.quantity > 0 %}
                    <div class="badge-stock is-critical" aria-label="Залишилось: {{ product.quantity }}">
                        залишилось: <span class="st-amt">{{ product.quantity }}</span>
                    </div>
                    {% endif %}
                </div>
                {# Smart lazy loading: first 3 products eager for LCP, rest lazy #}
                {% if forloop.counter <= 3 %}
                    {% product_image_picture product '400x300' 'tm-card-img' product.name 400 300 'eager' %}
                {% else %}
                    {% product_image_picture product '400x300' 'tm-card-img' product.name 400 300 'lazy' %}
                {% endif %}
            </div>

            <div class="tm-card-info">
                <h3 id="prod-title-{{ product.id }}" class="tm-card-title">{{ product.name }}</h3>
                {% if product.short_description %}
                <p class="tm-card-subtitle">{{ product.short_description }}</p>
                {% endif %}
                {% if product.discount %}
                <div class="tm-card-price">
                    <span class="price-old">{{ product.price }}₴</span>
                    <span class="price-new">{{ product.sell_price }}₴</span>
                </div>
                {% else %}
                <div class="tm-card-price">
                    <span class="price">{{ product.price }}₴</span>
                </div>
                {% endif %}
            </div>
        </a>

        <div class="tm-card-actions">
            {% if product.quantity > 0 %}
            <button class="add-to-cart-btn"
                    data-product-id="{{ product.id }}"
                    data-cart-add-url="{% url 'carts:cart_add' %}">
                В корзину
            </button>
            {% else %}
            <button class="add-to-cart-btn" disabled aria-disabled="true" title="Немає в наявності">
                Немає в наявності
            </button>
            {% endif %}
        </div>
    </article>
    {% empty %}
    <div class="product-empty">Нет товаров в этой категории.</div>
    {% endfor %}
</div>

{# Пагинация — сохраняет GET-параметры автоматически (но JS перехватит клики и выполнит AJAX) #}
{% if is_paginated %}
<nav class="pagination" aria-label="Навигация по страницам">
  <ul class="pagination-list">
    {% if page_obj.has_previous %}
      <li class="page-nav"><a href="?page={{ page_obj.previous_page_number }}" class="pagination-link" aria-label="Предыдущая">‹</a></li>
    {% endif %}

    {# Левое многоточие #}
    {% if page_obj.number > 3 %}
      <li class="ellipsis" aria-hidden="true">…</li>
    {% endif %}

    {# Диапазон вокруг текущей страницы: текущая-2 .. текущая+2 #}
    {% for num in paginator.page_range %}
      {% if num >= page_obj.number|add:-2 and num <= page_obj.number|add:2 %}
        <li class="{% if num == page_obj.number %}active{% endif %}">
          <a href="?page={{ num }}" class="pagination-link" aria-current="{% if num == page_obj.number %}page{% endif %}">{{ num }}</a>
        </li>
      {% endif %}
    {% endfor %}

    {# Правое многоточие #}
    {% if page_obj.number < paginator.num_pages|add:-2 %}
      <li class="ellipsis" aria-hidden="true">…</li>
    {% endif %}

    {% if page_obj.has_next %}
      <li class="page-nav"><a href="?page={{ page_obj.next_page_number }}" class="pagination-link" aria-label="Следующая">›</a></li>
    {% endif %}
  </ul>
</nav>
{% endif %}

{# Category presentation: placed at bottom to appear under products #}
{% if current_category_obj %}
<section id="category-presentation" class="category-presentation">
    <div class="category-presentation-inner">
        <div class="category-presentation-media">
            {% if current_category_obj.image %}
                <img src="{{ current_category_obj.image.url }}" alt="{{ current_category_obj.name }}" class="category-presentation-image"/>
            {% else %}
                <div class="category-presentation-image placeholder" aria-hidden="true"></div>
            {% endif %}
        </div>
        <div class="category-presentation-content">
            <h2 class="category-presentation-title">{{ current_category_obj.name }}</h2>
            {% if current_category_obj.description %}
                <div class="category-presentation-description">{{ current_category_obj.description|safe }}</div>
            {% elif current_category_obj.short_description %}
                <p class="category-presentation-description">{{ current_category_obj.short_description }}</p>
            {% endif %}
        </div>
    </div>
</section>
{% endif %}