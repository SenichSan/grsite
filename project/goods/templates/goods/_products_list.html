{% load static %}

<div class="catalog-current-title">
    {% if current_category and current_category != 'all' %}
        {% for cat in categories %}
            {% if cat.slug == current_category %}
                <h2 class="catalog-category-heading">Товари категорії <span>{{ cat.name }}</span></h2>
            {% endif %}
        {% endfor %}
    {% else %}
        <h2 class="catalog-category-heading">Всі товари</h2>
    {% endif %}
    
</div>

<div class="tm-featured-grid" role="list" aria-label="Товары">
    {% for product in goods %}
    <article class="tm-product-card" role="listitem" aria-labelledby="prod-title-{{ product.id }}">
        <a href="{% url 'goods:product' product.slug %}" class="tm-product-link" aria-label="{{ product.name }}">
            <div class="tm-card-image-wrap">
                {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="tm-card-img" loading="lazy" width="400" height="300"/>
                {% elif product.images.all|length > 0 %}
                <img src="{{ product.images.all.0.image.url }}" alt="{{ product.name }}" class="tm-card-img" loading="lazy" width="400" height="300"/>
                {% else %}
                <img src="{% static 'deps/images/placeholder.png' %}" alt="placeholder" class="tm-card-img" loading="lazy" width="400" height="300"/>
                {% endif %}
            </div>

            <div class="tm-card-info">
                <h3 id="prod-title-{{ product.id }}" class="tm-card-title">{{ product.name }}</h3>
                {% if product.short_description %}
                <p class="tm-card-subtitle">{{ product.short_description }}</p>
                {% endif %}
                <p class="tm-card-price">
                    {% if product.discount %}
                        {{ product.sell_price }}₴
                    {% else %}
                        {{ product.price }}₴
                    {% endif %}
                </p>
            </div>
        </a>

        <div class="tm-card-actions">
            <button class="add-to-cart-btn"
                    data-product-id="{{ product.id }}"
                    data-cart-add-url="{% url 'carts:cart_add' %}">
                В корзину
            </button>
        </div>
    </article>
    {% empty %}
    <div class="product-empty">Нет товаров в этой категории.</div>
    {% endfor %}
</div>

{# Пагинация — сохраняет GET-параметры автоматически (но JS перехватит клики и выполнит AJAX) #}
{% if is_paginated %}
<nav class="pagination" aria-label="Навигация по страницам">
  <ul class="pagination-list">
    {% if page_obj.has_previous %}
      <li class="page-nav"><a href="?page={{ page_obj.previous_page_number }}" class="pagination-link" aria-label="Предыдущая">‹</a></li>
    {% endif %}

    {# Левое многоточие #}
    {% if page_obj.number > 3 %}
      <li class="ellipsis" aria-hidden="true">…</li>
    {% endif %}

    {# Диапазон вокруг текущей страницы: текущая-2 .. текущая+2 #}
    {% for num in paginator.page_range %}
      {% if num >= page_obj.number|add:-2 and num <= page_obj.number|add:2 %}
        <li class="{% if num == page_obj.number %}active{% endif %}">
          <a href="?page={{ num }}" class="pagination-link" aria-current="{% if num == page_obj.number %}page{% endif %}">{{ num }}</a>
        </li>
      {% endif %}
    {% endfor %}

    {# Правое многоточие #}
    {% if page_obj.number < paginator.num_pages|add:-2 %}
      <li class="ellipsis" aria-hidden="true">…</li>
    {% endif %}

    {% if page_obj.has_next %}
      <li class="page-nav"><a href="?page={{ page_obj.next_page_number }}" class="pagination-link" aria-label="Следующая">›</a></li>
    {% endif %}
  </ul>
</nav>
{% endif %}