{% load static carts_tags %}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Grownica — Оформление заказа</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- Project global styles (optional) -->
    <link rel="stylesheet" href="{% static 'deps/css/header-hero.css' %}">
    <link rel="stylesheet" href="{% static 'deps/css/discount_badge.css' %}">
    <link rel="stylesheet" href="{% static 'deps/css/footer.css' %}">
    <link rel="stylesheet" href="{% static 'deps/css/templatemo-style.css' %}">
    <link rel="stylesheet" href="{% static 'deps/css/create_order.css' %}">
    
</head>
<body class="checkout-page">
  <div class="container home-framed">
    {% include 'components/header-hero.html' %}

    <main>
    <div class="mt-4">
        <div class="row">
            <div class="col-xl-7">
                <div class="card checkout-form-card mb-4">
                    <div class="card-body">
                        <ol class="activity-checkout list-unstyled mb-0 px-4 mt-3">
                            <li class="checkout-item">
                                <div class="avatar checkout-icon p-1">
                                    <div class="avatar-title rounded-circle bg-primary">
                                        <i class="bx bxs-receipt text-white"></i>
                                    </div>
                                </div>
                                <h5 class="fw-bold">Детали заказа</h5>
                                {% if form.errors %}
                                <div class="alert alert-danger">
                                    <ul>
                                        {% for field in form %}
                                        {% for error in field.errors %}
                                        <li>{{ field.label }}: {{ error }}</li>
                                        {% endfor %}
                                        {% endfor %}
                                        {% for error in form.non_field_errors %}
                                        <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                                <form action="{% url 'orders:create_order' %}" method="post" id="create_order_form">
                                    {% csrf_token %}

                                    <!-- Имя и Фамилия в одной строке -->
                                    <div class="row g-3">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label" for="id_first_name">Имя<span class="req-star">*</span></label>
                                            <input type="text" name="first_name" id="id_first_name"
                                                   value="{{ form.first_name.value|default_if_none:'' }}" class="form-control"
                                                   autocomplete="given-name" inputmode="text"
                                                   required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label" for="id_last_name">Фамилия<span class="req-star">*</span></label>
                                            <input type="text" name="last_name" id="id_last_name"
                                                   value="{{ form.last_name.value|default_if_none:'' }}" class="form-control"
                                                   autocomplete="family-name" inputmode="text"
                                                   required>
                                        </div>
                                    </div>

                                    <!-- Телефон и Email в одной строке -->
                                    <div class="row g-3">
                                        <div class="col-md-6 mb-3">
                                            <label for="id_phone_number" class="form-label">Номер телефона<span class="req-star">*</span>:</label>
                                            <input type="tel" class="form-control" id="id_phone_number" name="phone_number"
                                                   value="{% if form.phone_number.value %}{{ form.phone_number.value }}{% endif %}"
                                                   placeholder="+380 XX XXX XX XX" inputmode="tel"
                                                   pattern="^\+?380\s?\d{2}\s?\d{3}\s?\d{2}\s?\d{2}$"
                                                   title="Формат: +380 XX XXX XX XX"
                                                   autocomplete="tel" required>
                                            {% if form.phone_number.errors %}
                                            <div class="alert alert-danger alert-dismissible fade show">
                                                {{form.phone_number.errors}}
                                            </div>
                                            {% endif %}
                                            <div class="alert alert-danger alert-dismissible fade show" style="display: none"
                                                 id="phone_number_error" aria-live="polite">Неверный формат номера
                                            </div>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label class="form-label" for="id_email">Email<span class="req-star">*</span></label>
                                            <input type="email" name="email" id="id_email"
                                                   value="{{ form.email.value|default_if_none:'' }}" class="form-control"
                                                   autocomplete="email" inputmode="email"
                                                   required>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label d-block">Способ доставки<span class="req-star">*</span></label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="delivery_method"
                                                   id="delivery_courier" value="courier" required checked>
                                            <label class="form-check-label" for="delivery_courier">Нова Пошта</label>
                                        </div>
                                    </div>

                                    <!-- Населений пункт и Відділення/поштомат в одной строке -->
                                    <div class="row g-3">
                                        <div class="col-md-6 mb-3">
                                            <label for="nova_city" class="form-label">Населений пункт<span class="req-star">*</span></label>
                                            <input type="text" class="form-control" id="nova_city"
                                                   placeholder="Начните вводить..." autocomplete="address-level2" required>
                                            <input type="hidden" name="city_ref" id="nova_city_ref">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="warehouse_display" class="form-label">Відділення або поштомат<span class="req-star">*</span></label>
                                            <select class="form-select" id="warehouse_display" name="warehouse_ref" required>
                                                <option value="">Сначала выберите город</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Восстановленные поля -->
                                    <input type="hidden" name="delivery_address" id="id_delivery_address">

                                    <div class="mb-3">
                                        <label class="form-label d-block">Способ оплаты:</label>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="payment_on_get"
                                                   id="payment_cash" value="1" checked>
                                            <label class="form-check-label" for="payment_cash">Наложенный платёж</label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="order_comment" class="form-label">Комментарий к товару</label>
                                        <textarea class="form-control" id="order_comment" name="comment" rows="3"
                                                  placeholder="Если у вас есть вопросы, пожелания, предложения — можете вписать это сюда. Каждый комментарий будет учтён и прочитан."></textarea>
                                    </div>

                                    <div class="text-center mt-4">
                                        <button type="submit" class="btn btn-success btn-lg">Оформить заказ</button>
                                        <p class="form-text text-muted mt-2">Ваши контактные данные не будут сохранены в нашей базе данных</p>
                                    </div>
                                </form>
                            </li>
                        </ol>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <a href="{% url 'main:home' %}" class="btn btn-link text-muted">
                            <i class="mdi mdi-arrow-left me-1"></i> Продолжить покупки
                        </a>
                    </div>
                </div>
            </div>

            <div class="col-xl-5">
                <div class="card checkout-order-summary" data-cart-change-url="{% url 'carts:cart_change' %}">
                    <div class="card-body">
                        <div class="p-3 summary-title mb-3">
                            <h5>Итог заказа</h5>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-centered mb-0">
                                <thead>
                                <tr>
                                    <th scope="col" class="col-product">Товар</th>
                                    <th scope="col" class="col-qty text-center">Кол-во</th>
                                    <th scope="col" class="col-sum text-end">Сумма</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% user_carts request as carts %}
                                {% for item in carts %}
                                <tr class="order-item-row"
                                    data-cart-id="{{ item.id }}"
                                    data-unit-price="{{ item.product.price|floatformat:'2' }}"
                                    data-sell-price="{{ item.product.sell_price|floatformat:'2' }}"
                                    data-discount="{{ item.product.discount|floatformat:'2' }}"
                                    data-quantity="{{ item.quantity }}">
                                    <td>
                                        <div class="product-cell d-flex align-items-start">
                                            <a href="{% url 'goods:product' product_slug=item.product.slug %}" class="rp-link me-3">
                                                <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="rounded product-thumb">
                                            </a>
                                            <div class="product-info">
                                                <a href="{% url 'goods:product' product_slug=item.product.slug %}" class="rp-link d-block">{{ item.product.name }}</a>
                                                <div class="unit-price mt-1">
                                                    {% if item.product.discount %}
                                                        <span class="old-price text-decoration-line-through me-2">{{ item.product.price|floatformat:'0' }} ₴</span>
                                                        <span class="new-price text-success fw-semibold">{{ item.product.sell_price|floatformat:'0' }} ₴</span>
                                                    {% else %}
                                                        <span class="current-price fw-semibold">{{ item.product.sell_price|floatformat:'0' }} ₴</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center align-middle">
                                        <div class="qty-controls" role="group" aria-label="Количество">
                                            <button class="btn btn-sm qty-btn order-qty-dec" type="button" aria-label="Уменьшить">−</button>
                                            <span class="qty-value mx-2">{{ item.quantity }}</span>
                                            <button class="btn btn-sm qty-btn order-qty-inc" type="button" aria-label="Увеличить">+</button>
                                        </div>
                                    </td>
                                    <td class="line-sum text-end align-middle">{{ item.products_price|floatformat:'0' }}&nbsp;₴</td>
                                </tr>
                                {% endfor %}
                                <tr class="table-total-discount">
                                    <td colspan="2" class="text-end"><strong>Общая скидка:</strong></td>
                                    <td class="text-end"><strong id="order-total-discount" class="text-success">0 ₴</strong></td>
                                </tr>
                                <tr class="table-shipping-info">
                                    <td colspan="2" class="text-end"><strong>Доставка:</strong></td>
                                    <td class="text-end"><span class="text-muted">за тарифами перевозчика</span></td>
                                </tr>
                                <tr class="table-total">
                                    <td colspan="2" class="text-end"><strong>Итого:</strong></td>
                                    <td class="text-end"><strong>{{ carts.total_price|floatformat:'0' }}&nbsp;₴</strong></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </main>

    {% include 'components/footer.html' %}
  </div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

<!-- jQuery UI for autocomplete -->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<!-- Select2 for better dropdowns -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="{% static 'deps/js/create_order.js' %}"></script>

</body>
</html>
