{% extends "base.html" %}
{% load static %}
{% load carts_tags %}

{% block content %}
<div class="bg-white p-4 mb-4 mx-2 rounded custom-shadow">
    <div class="container">
        <h3 class="text-center mb-4">Выбранные товары</h3>
        <div class="container" id="cart-items-container">
            {% user_carts request as carts %}
            {% include "carts/includes/included_cart.html" %}
        </div>
    </div>

    <div class="container">
        <h3 class="text-center">Детали заказа</h3>
        <div class="card mb-3">
            <div class="card-body">
                <form action="{% url 'orders:create_order' %}" method="post" id="create_order_form">
                    {% csrf_token %}
                    <div class="row">
                        <!-- Имя -->
                        <div class="col-md-6 mb-3">
                            <label for="id_first_name" class="form-label">Имя*:</label>
                            <input type="text" class="form-control" id="id_first_name" name="first_name"
                                   value="{{ form.first_name.value|default:'' }}" required>
                        </div>

                        <!-- Фамилия -->
                        <div class="col-md-6 mb-3">
                            <label for="id_last_name" class="form-label">Фамилия*:</label>
                            <input type="text" class="form-control" id="id_last_name" name="last_name"
                                   value="{{ form.last_name.value|default:'' }}" required>
                        </div>

                        <!-- Телефон -->
                        <div class="col-md-6 mb-3">
                            <label for="id_phone_number" class="form-label">Номер телефона<span class="text-danger">*</span>:</label>
                            <input type="text" class="form-control" id="id_phone_number" name="phone_number"
                                   value="{{ form.phone_number.value|default:'' }}" placeholder="+(380) 000-0000" required>
                        </div>

                        <!-- Email -->
                        <div class="col-md-6 mb-3">
                            <label for="id_email" class="form-label">Email:</label>
                            <input type="email" class="form-control" id="id_email" name="email"
                                   value="{{ form.email.value|default:'' }}" required>
                        </div>

                        <!-- Способ доставки -->
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Способ доставки <span class="text-danger">*</span>:</label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="delivery_method" id="delivery_courier" value="courier" required>
                                <label class="form-check-label" for="delivery_courier">Укрпошта</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="delivery_method" id="delivery_np" value="nova_poshta" required>
                                <label class="form-check-label" for="delivery_np">Нова Пошта</label>
                            </div>
                        </div>

                        <!-- Город -->
                        <div class="col-md-6 mb-3">
                            <label for="id_city">Город <span class="text-danger">*</span>:</label>
                            <input type="text" name="city" id="id_city" class="form-control" list="cities-list" required>
                            <datalist id="cities-list"></datalist>
                            <input type="hidden" name="city_ref" id="city_ref">
                        </div>

                        <!-- Отделение -->
                        <div class="col-md-6 mb-3">
                            <label for="id_warehouse">Отделение <span class="text-danger">*</span>:</label>
                            <select name="warehouse" id="id_warehouse" class="form-control" required>
                                <option value="">Выберите отделение</option>
                            </select>
                        </div>

                        <!-- Способ оплаты -->
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Способ оплаты: </label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="payment_on_get" id="payment_card" value="0" checked>
                                <label class="form-check-label" for="payment_card">Оплата картой</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="payment_on_get" id="payment_cash" value="1">
                                <label class="form-check-label" for="payment_cash">При получении</label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-dark">Оформить заказ</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const cityInput = document.getElementById("id_city");
    const datalist = document.getElementById("cities-list");
    const cityRefInput = document.getElementById("city_ref");
    const warehouseSelect = document.getElementById("id_warehouse");

    let timer;
    cityInput.addEventListener("input", function () {
        clearTimeout(timer);
        const query = cityInput.value;
        if (query.length < 2) return;

        timer = setTimeout(() => {
            fetch(`/orders/ajax/search-city/?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    datalist.innerHTML = "";
                    data.forEach(city => {
                        const option = document.createElement("option");
                        option.value = city.label;
                        option.dataset.ref = city.ref; // SettlementRef
                        datalist.appendChild(option);
                    });
                });
        }, 300);
    });

    cityInput.addEventListener("change", function () {
        const selectedOption = Array.from(datalist.options)
            .find(opt => opt.value === cityInput.value);
        if (!selectedOption) return;

        const settlementRef = selectedOption.dataset.ref;
        cityRefInput.value = settlementRef;

        warehouseSelect.innerHTML = "<option>Загрузка...</option>";

        fetch("{% url 'orders:get_warehouses' %}?settlement_ref=" + encodeURIComponent(settlementRef))
            .then(res => res.json())
            .then(data => {
                warehouseSelect.innerHTML = "";
                if (data.success && data.warehouses.length) {
                    data.warehouses.forEach(wh => {
                        const opt = document.createElement("option");
                        opt.value = wh;
                        opt.text = wh;
                        warehouseSelect.appendChild(opt);
                    });
                } else {
                    warehouseSelect.innerHTML = "<option>Нет отделений</option>";
                }
            })
            .catch(err => {
                console.error("Ошибка загрузки:", err);
                warehouseSelect.innerHTML = "<option>Ошибка загрузки</option>";
            });
    });
});
</script>
{% endblock %}
