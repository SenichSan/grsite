{% extends 'base.html' %}
{% load static %}
{% load media_extras %}

{% block css %}
  <!-- Performance hints -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Preload LCP hero image (AVIF): mobile 800px, desktop 1600px -->
  <link rel="preload" as="image" href="{% static 'deps/images/bg-image-blur-800.avif' %}" type="image/avif" media="(max-width: 599px)" fetchpriority="high">
  <link rel="preload" as="image" href="{% static 'deps/images/bg-image-blur-1600.avif' %}" type="image/avif" media="(min-width: 600px)" fetchpriority="high">

  <!-- Home-only layout overrides: header flush to top, full-bleed blocks -->
  <style>
    /* Убираем верх/низ от main.container и делаем его full-bleed только на главной */
    main.container.my-4 {
      margin-top: 0 !important;
      margin-bottom: 0 !important;
      /* боковые поля контейнера оставляем как в проекте */
    }

    /* Утилита: full-bleed — растянуть секцию на всю ширину вьюпорта на мобильных */
    @media (max-width: 768px) {
      .full-bleed {
        width: 100vw;
        margin-left: calc(50% - 50vw);
        margin-right: calc(50% - 50vw);
      }
    }
  </style>

  <!-- Home-only: fix social icons size in header to 49x49 -->
  <style>
    .header-hero .tm-social-link { width: 49px; height: 49px; }
  </style>

  <!-- Шрифты: на мобилке оставляем только Poppins 400/600 и делаем не блокирующим -->
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"></noscript>

  <!-- Глобальные/тематические стили, нужные именно на главной -->
  <!-- Critical styles with preload -->
  <link href="{% static 'deps/css/templatemo-style.css' %}" rel="stylesheet"/>
  <link rel="preload" as="style" href="{% static 'deps/css/discount_badge.css' %}" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="{% static 'deps/css/discount_badge.css' %}"></noscript>

  <!-- Secondary styles via preload+onload to avoid render-blocking -->
  <link rel="preload" as="style" href="{% static 'deps/css/seo-text.css' %}" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="{% static 'deps/css/seo-text.css' %}"></noscript>
  <link rel="preload" as="style" href="{% static 'deps/css/news_slider.css' %}" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="{% static 'deps/css/news_slider.css' %}"></noscript>
  <link rel="stylesheet" href="{% static 'deps/css/categories-glass.css' %}">

  <link rel="preload" as="style" href="{% static 'deps/css/bestsellers-carousel.css' %}" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="{% static 'deps/css/bestsellers-carousel.css' %}"></noscript>
  <link rel="preload" as="style" href="{% static 'deps/css/footer.css' %}" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="{% static 'deps/css/footer.css' %}"></noscript>
  <link rel="preload" as="style" href="{% static 'deps/css/cart-component.css' %}" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="{% static 'deps/css/cart-component.css' %}"></noscript>
  <link rel="preload" as="style" href="{% static 'deps/css/faq.css' %}" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="{% static 'deps/css/faq.css' %}"></noscript>

  <!-- Slick carousel CSS (non‑blocking) -->
  <link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" onload="this.onload=null;this.rel='stylesheet'"/>
  <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/></noscript>
  <link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css" onload="this.onload=null;this.rel='stylesheet'"/>
  <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css"/></noscript>

  <!-- Preload background image variants for SEO text section -->
  <link rel="preload" as="image" href="{% static 'deps/images/seo-text-bg.avif' %}" type="image/avif" fetchpriority="high">
  {# Preload first 4 category icons as LCP candidates on mobile only #}
  {% with top_categories=categories|slice:":4" %}
    {% for cat in top_categories %}
      {% category_best_img_src cat '128x128' as cat_preload %}
      {% if cat_preload %}
        <link rel="preload" as="image" href="{{ cat_preload }}" media="(max-width: 599px)" fetchpriority="high">
      {% endif %}
    {% endfor %}
  {% endwith %}
{% endblock %}

{% block content %}
  <div class="container home-framed">
    <div class="full-bleed">
      {% include 'components/header-hero.html' %}
    </div>

    <div class="tm-paging-links-wrap full-bleed">
      <nav class="tm-paging-links" aria-label="Категорії">
        <h2 class="tm-section-title category-section-title">Оберіть бажану категорію</h2>
        <ul class="tm-paging-list">
          {% for category in categories %}
          <li class="tm-paging-item">
            <a href="{% url 'catalog:index' category.slug %}"
               class="tm-paging-link category-card"
               aria-current="{% if category.slug == current_category %}true{% endif %}">
              <div class="category-icon-wrap">
                {% category_icon_picture category '128x128' 'category-icon' category.name 128 128 'eager' 'high' %}
              </div>
              <div class="category-label">{{ category.name }}</div>
              {% if category.short_description %}
              <div class="category-subtitle tm-card-subtitle">{{ category.short_description }}</div>
              {% endif %}
            </a>
          </li>
          {% endfor %}
        </ul>
      </nav>
    </div>

    <div class="full-bleed">
      {% include 'components/bestsellers-carousel.html' %}
    </div>

    <div class="full-bleed">
      {% include "components/news_slider.html" with news_list=news_list %}
    </div>

    <div class="full-bleed">
      {% include "components/seo_text_section.html" %}
    </div>

    <section id="faq-section" class="full-bleed">
      <div class="faq-container">
        <div class="accordion">
          {% include "components/faq.html" %}
        </div>
      </div>
    </section>

    <div class="full-bleed">
      {% include 'components/footer.html' %}
    </div>
  </div>

  {% include 'components/cart_button.html' %}
  {% include 'components/cart_modal.html' %}
{% endblock %}

{% block extra_js %}
  <!-- Отложенная загрузка декоративных шрифтов (не критично для мобилки) -->
  <script>
    window.addEventListener('load', function(){
      var fonts = [
        'https://fonts.googleapis.com/css?family=Open+Sans:400',
        'https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap',
        'https://fonts.googleapis.com/css2?family=Marck+Script&display=swap',
        'https://fonts.googleapis.com/css2?family=Ruslan+Display&display=swap'
      ];
      fonts.forEach(function(href){
        var l = document.createElement('link');
        l.rel = 'stylesheet';
        l.href = href;
        l.media = 'all';
        document.head.appendChild(l);
      });
    });
  </script>
  <!-- Slick JS будет загружен по требованию (on-demand) ниже -->

  <!-- Локальные скрипты главной -->
  <script defer src="{% static 'deps/js/faq.js' %}"></script>
  <script defer src="{% static 'deps/js/news_slider.js' %}"></script>
  <script defer src="{% static 'deps/js/categories-glass.js' %}"></script>
  <script defer src="{% static 'deps/js/bestsellers-tilt.js' %}"></script>
  <script defer src="{% static 'deps/js/jquery-ajax.js' %}"></script>
  <script defer src="{% static 'deps/js/bestsellers-carousel.js' %}"></script>
  <script defer src="{% static 'deps/js/cart-component.js' %}"></script>

  <script>
    (function(){
      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const isNarrow = Math.max(window.innerWidth, document.documentElement.clientWidth) < 768;
      const target = document.querySelector('.tm-featured-carousel');
      if (!target) return;

      function loadSlick(cb){
        if (window.jQuery && $.fn && $.fn.slick) { cb && cb(); return; }
        var s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js';
        s.defer=true; s.onload=function(){ cb && cb(); };
        document.head.appendChild(s);
      }

      function initCarousel(){
        if (!window.jQuery) return; // wait for jQuery from base.html
        if (!($.fn && $.fn.slick)) { loadSlick(initCarousel); return; }
        if (target.getAttribute('data-slick-initialized')) return;
        target.setAttribute('data-slick-initialized','1');
        $(target).slick({
          infinite: true,
          slidesToShow: 5,
          slidesToScroll: 1,
          arrows: true,
          dots: false,
          autoplay: !(prefersReduced || isNarrow),
          autoplaySpeed: 3200,
          speed: prefersReduced ? 0 : 900,
          pauseOnHover: true,
          pauseOnFocus: true,
          centerPadding: '30px',
          appendArrows: $('.tm-featured-wrapper .container'),
          prevArrow: '<button type="button" class="slick-prev slick-arrow">‹</button>',
          nextArrow: '<button type="button" class="slick-next slick-arrow">›</button>',
          responsive: [
            { breakpoint: 1200, settings: { slidesToShow: 4 }},
            { breakpoint: 992,  settings: { slidesToShow: 3 }},
            { breakpoint: 768,  settings: { slidesToShow: 2 }},
            { breakpoint: 576,  settings: { slidesToShow: 1 }}
          ]
        });
      }

      if ('IntersectionObserver' in window) {
        const io = new IntersectionObserver((entries, obs) => {
          entries.forEach(e => {
            if (e.isIntersecting) { initCarousel(); obs.disconnect(); }
          });
        }, { rootMargin: '120px 0px' });
        io.observe(target);
      } else {
        // Fallback: init after load
        if (document.readyState === 'complete') initCarousel();
        else window.addEventListener('load', initCarousel);
      }
    })();
  </script>

  <!-- Tawk.to -->
  <script type="text/javascript">
    (function(){
      function injectTawk(){
        if (window.__tawkLoaded) return; window.__tawkLoaded = true;
        var s1=document.createElement('script');
        s1.async=true;
        s1.src='https://embed.tawk.to/6896970ca4fc79192a7bea9e/1j263s266';
        s1.charset='UTF-8';
        s1.setAttribute('crossorigin','*');
        var s0=document.getElementsByTagName('script')[0];
        s0.parentNode.insertBefore(s1,s0);
      }
      // Load lazily: try requestIdleCallback, then after window load, fallback timeout
      if ('requestIdleCallback' in window) {
        requestIdleCallback(injectTawk, { timeout: 4000 });
      } else {
        window.addEventListener('load', function(){ setTimeout(injectTawk, 2000); });
      }
    })();
  </script>
{% endblock %}